amis.define("4cd9fa4",(function(e,t,n,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=e("849c8c1"),i=e("cc4bbf0"),o=e("eb0cd8e"),l=e("167c905"),d=e("8ba532b"),s=e("fb32b1a");function u(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var c=u(i),p=u(o);function b(e){for(var t=0,n=0,a=0;a<e.length;a++){var r=(e[a].tds||[]).length;r>t&&(n=a,t=r)}return n}var m=function(e){function t(t){var n=e.call(this,t)||this;Object.defineProperty(n,"tableViewWrapperRef",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(n,"draggingId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(n,"draggingElement",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(n,"draggingElementTop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(n,"draggingElementLeft",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(n,"startX",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(n,"startY",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(n,"maxChildTrIndex",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(n,"store",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(n,"isSelectionCell",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(n,"selectedCell",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(n,"preventTableClick",{enumerable:!0,configurable:!0,writable:!0,value:!1}),n.tableViewWrapperRef=c.default.createRef(),n.store=n.props.manager.store;var a=n.props.schema.trs||[];if(a.length){var r=a.map((function(e){return e.$$id})),i=b(a);n.maxChildTrIndex=i;var o=(a[i].tds||[]).map((function(e){return e.$$id}));n.state={trIds:r,tdIds:o,displayMergeCell:!1}}else n.state={trIds:[],tdIds:[],displayMergeCell:!1};return n.listenTdSelection(),n}return r.__extends(t,e),Object.defineProperty(t.prototype,"componentDidMount",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.syncLinePos(),this.listenTdSelection()}}),Object.defineProperty(t.prototype,"componentWillUnmount",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.removeListenTdSelection()}}),Object.defineProperty(t.prototype,"syncLineState",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this,t=this.props.schema.trs||[];if(t.length){var n=t.map((function(e){return e.$$id})),a=b(t);this.maxChildTrIndex=a;var r=(t[a].tds||[]).map((function(e){return e.$$id}));this.setState({trIds:n,tdIds:r},(function(){e.syncLinePos()}))}}}),Object.defineProperty(t.prototype,"removeListenTdSelection",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this.tableViewWrapperRef.current;if(e){var t=e.querySelector("tbody");t.removeEventListener("mousedown",this.handleCellMouseDown),t.removeEventListener("mousemove",this.handleCellMouseMove),t.removeEventListener("mouseup",this.handleCellMouseUp),t.removeEventListener("click",this.handleCellMouseClick)}}}),Object.defineProperty(t.prototype,"listenTdSelection",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this.tableViewWrapperRef.current;if(e){var t=e.querySelector("tbody");t.addEventListener("mousedown",this.handleCellMouseDown),t.addEventListener("mousemove",this.handleCellMouseMove),t.addEventListener("mouseup",this.handleCellMouseUp),t.addEventListener("click",this.handleCellMouseClick)}}}),Object.defineProperty(t.prototype,"handleCellMouseDown",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t,n=e.target;if(!n||"TD"===n.tagName){this.removeAllSelectionMark(),this.setState({displayMergeCell:!1});var a=n.getAttribute("data-editor-id");this.isSelectionCell=!0,this.selectedCell=((t={})[a]=d.JSONGetById(this.props.schema,a),t)}}}),Object.defineProperty(t.prototype,"handleCellMouseMove",{enumerable:!1,configurable:!0,writable:!0,value:function(e){if(this.isSelectionCell){this.preventTableClick=!0;var t=e.target;if(t&&"TD"!==t.tagName)return;var n=t.getAttribute("data-editor-id");n in this.selectedCell||(this.selectedCell[n]=d.JSONGetById(this.props.schema,n),this.markSelectingCell(),this.setState({displayMergeCell:!0}))}}}),Object.defineProperty(t.prototype,"findFirstAndLastCell",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=[];for(var t in this.selectedCell)e.push(this.selectedCell[t]);e.length||console.warn(s.i18n("9efb0ce5a4510ef29345b6edb3e58bc2"));for(var n=e[0].$$col,a=e[0].$$row,r=0,i=0,o=null,l=0,d=e;l<d.length;l++){var u=d[l],c=u.$$col+(u.colspan||1)-1,p=u.$$row+(u.rowspan||1)-1;c>=r&&(r=c),p>=i&&(i=p),u.$$col<=n&&(n=u.$$col),u.$$row<=a&&(a=u.$$row),u.$$col===n&&u.$$row===a&&(o=u)}return{minRow:a,minCol:n,maxRow:i,maxCol:r,firstCell:o,lastCell:null}}}),Object.defineProperty(t.prototype,"markSelectingCell",{enumerable:!1,configurable:!0,writable:!0,value:function(){for(var e=this,t=this.findFirstAndLastCell(),n=t.minRow,a=t.minCol,r=t.maxRow,i=t.maxCol,o=0,l=this.props.schema.trs;o<l.length;o++)for(var d=0,s=l[o].tds;d<s.length;d++){var u=s[d],c=u;c.$$col>=a&&c.$$col<=i&&c.$$row>=n&&c.$$row<=r&&(c.$$id in this.selectedCell||(this.selectedCell[c.$$id]=u))}var p=this.tableViewWrapperRef.current;p&&p.querySelectorAll("td").forEach((function(t){t.getAttribute("data-editor-id")in e.selectedCell&&t.setAttribute("data-selected","1")}))}}),Object.defineProperty(t.prototype,"removeAllSelectionMark",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this.tableViewWrapperRef.current;e&&e.querySelectorAll("td").forEach((function(e){e.removeAttribute("data-selected")}))}}),Object.defineProperty(t.prototype,"handleCellMouseUp",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this.isSelectionCell=!1}}),Object.defineProperty(t.prototype,"handleCellMouseClick",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this.preventTableClick&&(e.stopPropagation(),e.preventDefault(),this.preventTableClick=!1)}}),Object.defineProperty(t.prototype,"handleMergeCell",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this.findFirstAndLastCell(),t=e.firstCell,n=e.minRow,a=e.minCol,r=e.maxRow,i=e.maxCol;if(t){var o=t.$$id,l=i-a+1,d=r-n+1;t.colspan=l,t.rowspan=d;var u=[];for(var c in this.selectedCell)u.push(this.selectedCell[c]);for(var p=u.filter((function(e){return e.$$id!==o})).map((function(e){return e.$$id})),b=this.props.schema.trs,m=b.length;m--;){var f=b[m];f.tds=f.tds.filter((function(e){return!p.includes(e.$$id)})),f.tds.length||b.splice(m,1)}var g=this.props.schema.$$id;this.store.changeValueById(g,this.props.schema),this.setState({displayMergeCell:!1})}else console.warn(s.i18n("3ce57bd19e37d2b27145dc6fcfff3520"))}}),Object.defineProperty(t.prototype,"syncLinePos",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this.tableViewWrapperRef.current;if(e){var t=e.querySelector("table").getBoundingClientRect(),n=e.querySelectorAll("tr");if(!n.length||void 0===this.maxChildTrIndex)return;for(var a=Array.from(e.querySelectorAll(".ae-TableViewEditor-rowLine")),r=0;r<n.length;r++)if(n[r]){var i=n[r].getBoundingClientRect();a[r]?a[r].style.top=i.top+i.height-t.top-3.5+"px":console.warn(s.i18n("f7d205072a2ceb63b4f48a8b6f32fd25"))}for(var o=n[this.maxChildTrIndex].querySelectorAll("td"),l=Array.from(e.querySelectorAll(".ae-TableViewEditor-colLine")),d=0;d<o.length;d++){var u=o[d];if(u){var c=u.getBoundingClientRect();l[d]?l[d].style.left=c.left+c.width-t.left-3.5+"px":console.warn(s.i18n("852228c640b1daefe6b0853390e66791"))}}}}}),Object.defineProperty(t.prototype,"componentDidUpdate",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=e.schema,n=this.props.schema;p.default(t,n)||this.syncLineState()}}),Object.defineProperty(t.prototype,"lineMouseDownCommon",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this.startY=e.clientY,this.startX=e.clientX;var t=e.currentTarget;this.draggingElement=t,this.draggingElementTop=parseInt(this.draggingElement.style.top,10),this.draggingElementLeft=parseInt(this.draggingElement.style.left,10),t.style.background="#4285f4",this.draggingId=t.getAttribute("data-id"),t.addEventListener("click",this.handleLineClick,{once:!0})}}),Object.defineProperty(t.prototype,"handleRowMouseDown",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this.lineMouseDownCommon(e),document.addEventListener("mousemove",this.handleRowMouseMove),document.addEventListener("mouseup",this.handleRowMouseUp)}}),Object.defineProperty(t.prototype,"handleRowMouseMove",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=e.clientY-this.startY;this.draggingElement.style.top=this.draggingElementTop+t+"px"}}),Object.defineProperty(t.prototype,"handleRowMouseUp",{enumerable:!1,configurable:!0,writable:!0,value:function(e){document.removeEventListener("mousemove",this.handleRowMouseMove),document.removeEventListener("mouseup",this.handleRowMouseUp);var t=e.clientY-this.startY,n=this.store,a=this.draggingId,i=n.getValueOf(a),o=this.tableViewWrapperRef.current.querySelector('tr[data-editor-id="'.concat(a,'"]'));if(this.draggingElement.style.background="none",i&&o){var d=o.getBoundingClientRect().height+t;n.changeValueById(a,r.__assign(r.__assign({},i),{height:d})),42-d>20&&l.toast.warning(s.i18n("38d2ccdde0ae0c2329defd3c75c59d8b"))}else console.warn(s.i18n("26526c3354307798dfa84f17decf5140"),a)}}),Object.defineProperty(t.prototype,"handleColMouseDown",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this.lineMouseDownCommon(e),document.addEventListener("mousemove",this.handleColMouseMove),document.addEventListener("mouseup",this.handleColMouseUp)}}),Object.defineProperty(t.prototype,"handleColMouseMove",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=e.clientX-this.startX;this.draggingElement.style.left=this.draggingElementLeft+t+"px"}}),Object.defineProperty(t.prototype,"handleColMouseUp",{enumerable:!1,configurable:!0,writable:!0,value:function(e){document.removeEventListener("mousemove",this.handleColMouseMove),document.removeEventListener("mouseup",this.handleColMouseUp);var t=e.clientX-this.startX,n=this.store,a=this.draggingId,i=n.getValueOf(a),o=this.tableViewWrapperRef.current.querySelector('td[data-editor-id="'.concat(a,'"]'));if(this.draggingElement.style.background="none",i&&o){var l=o.getBoundingClientRect().width+t;n.changeValueById(a,r.__assign(r.__assign({},i),{width:l}))}else console.warn(s.i18n("26526c3354307798dfa84f17decf5140"),a)}}),Object.defineProperty(t.prototype,"handleLineClick",{enumerable:!1,configurable:!0,writable:!0,value:function(e){e.stopPropagation(),e.preventDefault()}}),Object.defineProperty(t.prototype,"renderMergeIcon",{enumerable:!1,configurable:!0,writable:!0,value:function(){return this.state.displayMergeCell?c.default.createElement("div",{className:"ae-TableViewEditor-mergeIcon",onMouseDown:this.handleMergeCell},"合并单元格"):null}}),Object.defineProperty(t.prototype,"render",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this,t=this.props,n=t.children,a=t.schema,r=this.state.trIds.map((function(t){return c.default.createElement("div",{className:"ae-TableViewEditor-rowLine",key:"row-".concat(t),"data-id":t,onMouseDown:e.handleRowMouseDown})})),i=this.state.tdIds.map((function(t){return c.default.createElement("div",{className:"ae-TableViewEditor-colLine",key:"row-".concat(t),"data-id":t,onMouseDown:e.handleColMouseDown})}));return c.default.createElement("div",{className:"ae-TableViewEditor",ref:this.tableViewWrapperRef,style:null==a?void 0:a.style},n,this.renderMergeIcon(),r,i)}}),r.__decorate([d.autobind,r.__metadata("design:type",Function),r.__metadata("design:paramtypes",[]),r.__metadata("design:returntype",void 0)],t.prototype,"removeListenTdSelection",null),r.__decorate([d.autobind,r.__metadata("design:type",Function),r.__metadata("design:paramtypes",[]),r.__metadata("design:returntype",void 0)],t.prototype,"listenTdSelection",null),r.__decorate([d.autobind,r.__metadata("design:type",Function),r.__metadata("design:paramtypes",[MouseEvent]),r.__metadata("design:returntype",void 0)],t.prototype,"handleCellMouseDown",null),r.__decorate([d.autobind,r.__metadata("design:type",Function),r.__metadata("design:paramtypes",[MouseEvent]),r.__metadata("design:returntype",void 0)],t.prototype,"handleCellMouseMove",null),r.__decorate([d.autobind,r.__metadata("design:type",Function),r.__metadata("design:paramtypes",[MouseEvent]),r.__metadata("design:returntype",void 0)],t.prototype,"handleCellMouseUp",null),r.__decorate([d.autobind,r.__metadata("design:type",Function),r.__metadata("design:paramtypes",[MouseEvent]),r.__metadata("design:returntype",void 0)],t.prototype,"handleCellMouseClick",null),r.__decorate([d.autobind,r.__metadata("design:type",Function),r.__metadata("design:paramtypes",[]),r.__metadata("design:returntype",void 0)],t.prototype,"handleMergeCell",null),r.__decorate([d.autobind,r.__metadata("design:type",Function),r.__metadata("design:paramtypes",[Object]),r.__metadata("design:returntype",void 0)],t.prototype,"handleRowMouseDown",null),r.__decorate([d.autobind,r.__metadata("design:type",Function),r.__metadata("design:paramtypes",[MouseEvent]),r.__metadata("design:returntype",void 0)],t.prototype,"handleRowMouseMove",null),r.__decorate([d.autobind,r.__metadata("design:type",Function),r.__metadata("design:paramtypes",[MouseEvent]),r.__metadata("design:returntype",void 0)],t.prototype,"handleRowMouseUp",null),r.__decorate([d.autobind,r.__metadata("design:type",Function),r.__metadata("design:paramtypes",[Object]),r.__metadata("design:returntype",void 0)],t.prototype,"handleColMouseDown",null),r.__decorate([d.autobind,r.__metadata("design:type",Function),r.__metadata("design:paramtypes",[MouseEvent]),r.__metadata("design:returntype",void 0)],t.prototype,"handleColMouseMove",null),r.__decorate([d.autobind,r.__metadata("design:type",Function),r.__metadata("design:paramtypes",[MouseEvent]),r.__metadata("design:returntype",void 0)],t.prototype,"handleColMouseUp",null),r.__decorate([d.autobind,r.__metadata("design:type",Function),r.__metadata("design:paramtypes",[MouseEvent]),r.__metadata("design:returntype",void 0)],t.prototype,"handleLineClick",null),t}(c.default.Component);t.TableViewEditor=m}));